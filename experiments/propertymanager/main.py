import json
import re

from typing import List

def strbool(b: bool):
    if b == True:
        return "true"
    else:
        return "false"

output = """// Generated by propertymanager

"""

filename = "test.json"
data = json.load(open(filename))

output += "void onLevelBegin() {\n"

output += "    // Weapon initalization\n\n"

output += "    jjWEAPONS[WEAPON::BLASTER].infinite = " + strbool(data["weapons"]["blaster"]["infinite"]) + ";\n"
output += "    jjWEAPONS[WEAPON::BLASTER].style    = SPREAD::" + data["weapons"]["blaster"]["spread"] + ";\n"
output += "    jjWEAPONS[WEAPON::BLASTER].spread   = WEAPON::" + data["weapons"]["blaster"]["style"] + ";\n"

output += "\n"

memory = []

def parseArgs(args: List[str]):
    global memory
    result = ""
    pattern = r'\${(\d+)}'

    def replace(match):
        index = int(match.group(1)) - 1
        if 0 <= index < len(memory):
            return memory[index]
        else:
            return match.group(0)
    
    for arg in args:
        result += re.sub(pattern, replace, arg)
    
    return result

def paddingToSpaces(padding: int) -> str:
    paddingStr = ""

    for x in range(padding):
        paddingStr += " "
    
    return paddingStr

def parseCommands(section):
    global output, memory
    padding = 4
    paddingStr = paddingToSpaces(padding)

    for (index, value) in enumerate(section):
        for (index_2, command) in enumerate(value):
            command = command
            args = value[command]

            if command != "endif":
                output += paddingStr
            
            if command == "log":
                output += "jjConsole(\"" + parseArgs(args) + "\");\n"
            elif command == "if":
                output += "if(" + parseArgs(args) + ") {\n"
                padding += 4
                paddingStr = paddingToSpaces(padding)
            elif command == "endif":
                padding -= 4
                paddingStr = paddingToSpaces(padding)
                output += paddingStr + "}\n\n"
            elif command == "eval":
                output += parseArgs(args)

if data["scripting"].get("onstart"):
    parseCommands(data["scripting"]["onstart"])

output += "}\n\n"
output += "bool onLocalChat(string &in stringReceived, CHAT::Type chatType) {\n"

if data["scripting"].get("onchat"):
    memory = ["\" + stringReceived + \""]

    parseCommands(data["scripting"]["onchat"])

output += "}\n\n"
memory = []

with open("out.j2as", "w") as f:
    f.write(output)
    f.close()
